# Article Sale & Delivery Improvements Plan

## Date: 2025-10-09

## Overview
This plan addresses improvements to the Article Sale functionality, delivery date selection, contact history tracking, and customer delivery remarks management.

---

## 1. Increase Size of Delivery Instructions/Remarks Textarea

### Current Issue
- The textarea for `bezorginstructies of opmerkingen` in 'Artikel verkoop' form has only 3 rows
- Too small for callcenter employees to comfortably enter delivery instructions

### Solution
**File**: `index.html`
- Increase textarea from `rows="3"` to `rows="5"`
- Add CSS styling for better visibility and usability

**CSS Changes** (`styles.css`):
```css
#articleNotes {
    min-height: 120px;
    font-size: 0.95rem;
    line-height: 1.5;
}
```

### Estimated Effort
- Low (5 minutes)

---

## 2. Advanced Delivery Date Picker

### Current Issue
- Current implementation uses simple HTML5 date picker
- Shows "Verwachte leverdatum" (Expected delivery date)
- No context about delivery availability or day of week
- Not optimized for call center usage during customer calls

### Solution

#### Phase 1: Rename and Basic Enhancement
**File**: `index.html` + `app.js`
- Change label from "Verwachte leverdatum" to "Gewenste leverdatum"
- Update field ID from `articleExpectedDelivery` to `articleDesiredDelivery`
- Update all references in JavaScript

#### Phase 2: Custom Delivery Date Picker Component
Create a specialized date picker with:

**Visual Features**:
- Calendar grid showing 2-3 weeks ahead
- Day-of-week headers prominently displayed
- Visual indicators:
  - ‚úÖ Green = Available delivery days
  - ‚õî Gray/disabled = No delivery days (Sundays + holidays)
  - üì¶ Blue highlight = Recommended fastest delivery
  - ‚ö†Ô∏è Yellow = Limited availability

**Business Logic**:
- No deliveries on Sundays
- No deliveries on national holidays (configurable list)
- Minimum lead time: 2 business days from order date
- Highlight the earliest available delivery date
- Show day name (Ma, Di, Wo, Do, Vr, Za) prominently

**UX Optimizations for Call Centers**:
- Large clickable date cells (touch/click friendly)
- Today's date clearly marked
- Keyboard navigation (arrow keys, Enter to select)
- Quick selection buttons:
  - "Eerst beschikbare" (First available)
  - "Volgende week" (Next week)
  - "Over 2 weken" (In 2 weeks)
- Show estimated delivery window on hover (e.g., "Donderdag 17 oktober - ochtend")

**Implementation Structure**:
```
New files:
- delivery-date-picker.js (Component logic)
- delivery-date-picker.css (Component styling)

Configuration:
- Dutch holidays list (Pasen, Pinksteren, Koningsdag, etc.)
- Delivery blackout dates
- Lead time settings
```

### Technical Details

**HTML Structure** (`index.html`):
```html
<div class="form-group">
    <label for="articleDesiredDelivery">Gewenste leverdatum *</label>
    <div id="deliveryDatePickerContainer" class="delivery-date-picker-container">
        <input type="hidden" id="articleDesiredDelivery" required>
        <div class="delivery-date-display" id="deliveryDateDisplay">
            Selecteer een datum...
        </div>
        <div class="delivery-calendar" id="deliveryCalendar" style="display: none;">
            <!-- Calendar will be generated by JS -->
        </div>
    </div>
</div>
```

**JavaScript Functions** (`delivery-date-picker.js`):
- `initDeliveryDatePicker()` - Initialize the picker
- `generateCalendar(startDate)` - Create calendar grid
- `isDeliveryAvailable(date)` - Check if date is valid for delivery
- `getDutchHolidays(year)` - Get list of Dutch holidays
- `selectDeliveryDate(date)` - Handle date selection
- `getRecommendedDate()` - Calculate earliest available date
- `formatDeliveryDate(date)` - Format display with day name

**Holiday Configuration**:
```javascript
const dutchHolidays = [
    { name: 'Nieuwjaarsdag', date: '01-01' },
    { name: 'Koningsdag', date: '04-27' },
    { name: 'Bevrijdingsdag', date: '05-05', everyFiveYears: true },
    { name: 'Eerste Kerstdag', date: '12-25' },
    { name: 'Tweede Kerstdag', date: '12-26' },
    // Pasen and Pinksteren are calculated dynamically
];
```

### Estimated Effort
- Phase 1: Low (15 minutes)
- Phase 2: Medium-High (3-4 hours)

---

## 3. Add Article Purchases to Contact History

### Current Issue
- Article purchases/sales are not being recorded in 'Contact Geschiedenis'
- Only subscription-related activities appear in timeline

### Solution

**File**: `app.js` - Update `createArticleSale()` function

Add contact history entry when article is purchased:
```javascript
currentCustomer.contactHistory.unshift({
    id: currentCustomer.contactHistory.length + 1,
    type: 'Artikel bestelling',
    date: new Date().toISOString(),
    description: `Artikel bestelling: ${formData.articleName} (${formData.quantity}x) - ‚Ç¨${formData.price.toFixed(2)}. Gewenste levering: ${formatDate(formData.desiredDeliveryDate)}. Betaling: ${formData.paymentMethod}.${formData.notes ? ' Opmerkingen: ' + formData.notes : ''}`
});
```

**Also Add**:
- Article delivery status updates to history when status changes
- Article cancellation entries (for deceased customers)
- Article return entries

**Additional Timeline Entry Types**:
- "Artikel verzonden" (tracking number included)
- "Artikel geleverd" (actual delivery date)
- "Artikel geannuleerd" (reason: customer deceased)
- "Artikel retour" (return reason)

### Estimated Effort
- Medium (1 hour)

---

## 4. Optimize Article Selection for 100+ Items

### Current Issue
- Article selection is a simple dropdown
- Real scenario: 100+ items across different magazine titles
- Not optimal for quick selection during calls
- Scrolling through long lists is inefficient

### Solution

#### Option A: Searchable Dropdown with Filtering
Create a custom searchable dropdown component:

**Features**:
- Text input field with autocomplete
- Filters as user types
- Shows top 10 matches
- Categories by magazine title (Avrobode, Mikrogids, Ncrvgids)
- Popular/frequent items pinned to top
- Show item code, name, and price
- Keyboard navigation (up/down arrows, Enter)

**HTML Structure**:
```html
<div class="form-group">
    <label for="articleSearch">Artikel *</label>
    <div class="article-selector">
        <input type="text" 
               id="articleSearch" 
               placeholder="Type artikel naam of code..." 
               autocomplete="off"
               oninput="filterArticles(this.value)">
        <input type="hidden" id="articleName" required>
        <div class="article-dropdown" id="articleDropdown" style="display: none;">
            <div class="article-category">Veelgebruikt</div>
            <!-- Popular items -->
            <div class="article-category">Avrobode</div>
            <!-- Avrobode items -->
            <div class="article-category">Mikrogids</div>
            <!-- Mikrogids items -->
        </div>
    </div>
</div>
```

**CSS Features**:
- Max height with scroll
- Highlighted search matches
- Visual distinction between categories
- Hover states for items
- Selected item highlighted

#### Option B: Tabbed Category Selection
Organize by magazine title with tabs:

**Features**:
- Tabs for each magazine (Avrobode, Mikrogids, Ncrvgids, Overig)
- Within each tab: visual grid of articles
- Click-to-select cards showing:
  - Article image/icon
  - Article name
  - Article code
  - Price
- Search bar above tabs for quick filter across all

### Recommended: Hybrid Approach
- **Default**: Searchable dropdown (Option A) for speed
- **Fallback**: "Browse alle artikelen" link opens modal with tabbed view (Option B)
- **Smart Suggestions**: Show recently used articles
- **Quick Access**: Number shortcuts (1-9) for top 9 frequent items

### Article Data Structure
```javascript
const articles = [
    {
        id: 1,
        code: 'AVR-JB-2023',
        name: 'Jaargang bundel 2023',
        magazine: 'Avrobode',
        price: 29.95,
        category: 'Jaargang bundels',
        popular: true,
        frequency: 45 // usage count
    },
    // ... 100+ items
];
```

### Estimated Effort
- Option A (Searchable): Medium (2-3 hours)
- Option B (Tabbed): Medium-High (3-4 hours)
- Hybrid: High (5-6 hours)

---

## 5. Cancel Article Deliveries for Deceased Customers

### Current Issue
- No way to cancel article deliveries if customer is deceased
- Need workflow for handling this sensitive situation

### Solution

#### UI Changes

**Add Cancel Button to Article Display**:
```html
<div class="article-actions">
    <button class="btn btn-small btn-danger" 
            onclick="cancelArticleDelivery(articleId, 'deceased')">
        ‚ùå Annuleer (Overleden)
    </button>
</div>
```

**Cancel Article Modal**:
```html
<div id="cancelArticleModal" class="modal">
    <div class="modal-content">
        <h3>Artikel levering annuleren</h3>
        <p>Reden: <strong>Klant overleden</strong></p>
        <p>Artikel: <span id="cancelArticleName"></span></p>
        <p class="warning">‚ö†Ô∏è Deze actie kan niet ongedaan gemaakt worden.</p>
        
        <label>
            <input type="checkbox" id="confirmDeceased" required>
            Ik bevestig dat de klant overleden is
        </label>
        
        <div class="modal-actions">
            <button onclick="closeCancelModal()">Annuleren</button>
            <button class="btn-danger" onclick="confirmCancelArticle()">
                Levering Annuleren
            </button>
        </div>
    </div>
</div>
```

#### JavaScript Functions

**New Functions** (`app.js`):
```javascript
function cancelArticleDelivery(articleId, reason) {
    // Show confirmation modal
    // On confirm:
    // 1. Update article status to 'cancelled'
    // 2. Add cancellation reason
    // 3. Add note to contact history
    // 4. Optionally notify fulfillment system
    // 5. Update customer account if deceased
}

function markCustomerDeceased(customerId) {
    // Set customer status to 'deceased'
    // Cancel all pending deliveries
    // Cancel all active subscriptions
    // Add comprehensive note to contact history
    // Prevent future orders
}
```

#### Article Status Updates
Add new status field to articles:
```javascript
article.deliveryStatus = 'cancelled-deceased';
article.cancellationDate = new Date().toISOString();
article.cancellationReason = 'Customer deceased';
```

#### Contact History Entry
```javascript
contactHistory.unshift({
    type: 'Artikel geannuleerd',
    date: new Date().toISOString(),
    description: `Artikel levering geannuleerd (${article.name}). Reden: Klant overleden. Order ID: ${article.id}.`,
    priority: 'high'
});
```

#### Customer Status Management
**Add Global Customer Status**:
```javascript
customer.status = 'deceased'; // or 'active', 'blocked', etc.
customer.statusDate = '2025-10-09';
customer.statusNote = 'Gemeld door familielid op [date]';
```

**Display Warning**:
When a deceased customer is selected, show prominent warning banner:
```html
<div class="customer-status-warning status-deceased">
    ‚ö†Ô∏è KLANT OVERLEDEN - Geen nieuwe bestellingen mogelijk
</div>
```

### Estimated Effort
- Medium (2-3 hours)

---

## 6. Delivery Remarks Shortlist

### Current Issue
- Common delivery remarks like "Bezorgen bij de buren indien niet thuis" must be typed each time
- Inefficient for call center employees
- Prone to typing errors and inconsistencies

### Solution

#### Quick Selection Buttons
Add pre-defined delivery remark buttons above the textarea:

**HTML Structure** (`index.html`):
```html
<div class="form-group">
    <label for="articleNotes">Bezorginstructies</label>
    <div class="delivery-remarks-shortcuts">
        <button type="button" class="remark-shortcut" 
                onclick="addDeliveryRemark('Bezorgen bij de buren indien niet thuis')">
            üë• Bij buren
        </button>
        <button type="button" class="remark-shortcut" 
                onclick="addDeliveryRemark('Achterdeur of zijdeur gebruiken')">
            üö™ Achterdeur
        </button>
        <button type="button" class="remark-shortcut" 
                onclick="addDeliveryRemark('Niet v√≥√≥r 12:00 uur bezorgen')">
            üïê Na 12:00
        </button>
        <button type="button" class="remark-shortcut" 
                onclick="addDeliveryRemark('Bellen voor levering')">
            üìû Bel eerst
        </button>
        <button type="button" class="remark-shortcut" 
                onclick="addDeliveryRemark('Pakketbrievenbus aanwezig')">
            üìÆ Brievenbus
        </button>
        <button type="button" class="remark-shortcut" 
                onclick="addDeliveryRemark('Voorzichtig behandelen - breekbaar')">
            ‚ö†Ô∏è Breekbaar
        </button>
    </div>
    <textarea id="articleNotes" 
              placeholder="Bezorginstructies of opmerkingen (optioneel)" 
              rows="5"></textarea>
</div>
```

**JavaScript Function**:
```javascript
function addDeliveryRemark(remark) {
    const notesField = document.getElementById('articleNotes');
    const currentValue = notesField.value.trim();
    
    if (currentValue) {
        // Append to existing notes
        notesField.value = currentValue + '\n' + remark;
    } else {
        // Set as first note
        notesField.value = remark;
    }
    
    // Visual feedback
    notesField.focus();
    notesField.scrollTop = notesField.scrollHeight;
}
```

**CSS Styling**:
```css
.delivery-remarks-shortcuts {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.remark-shortcut {
    padding: 0.4rem 0.8rem;
    border: 1px solid var(--border-color);
    background: var(--bg-secondary);
    border-radius: var(--radius-sm);
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
}

.remark-shortcut:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}
```

#### Configuration
Store most-used remarks in configuration:
```javascript
const commonDeliveryRemarks = [
    { id: 1, icon: 'üë•', text: 'Bezorgen bij de buren indien niet thuis', usage: 234 },
    { id: 2, icon: 'üö™', text: 'Achterdoor of zijdeur gebruiken', usage: 156 },
    { id: 3, icon: 'üïê', text: 'Niet v√≥√≥r 12:00 uur bezorgen', usage: 123 },
    { id: 4, icon: 'üìû', text: 'Bellen voor levering', usage: 98 },
    { id: 5, icon: 'üìÆ', text: 'Pakketbrievenbus aanwezig', usage: 87 },
    { id: 6, icon: '‚ö†Ô∏è', text: 'Voorzichtig behandelen - breekbaar', usage: 45 }
];
```

#### Advanced Features
- Track usage of shortcuts and reorder by frequency
- Allow custom remarks to be saved as shortcuts
- Admin panel to manage standard remarks
- Context-specific remarks based on article type

### Estimated Effort
- Medium (1-2 hours)

---

## 7. Edit Delivery Remarks for Loaded Customer

### Current Issue
- Once a customer is loaded, there's no way to edit their default delivery remarks
- Delivery preferences should be editable as customer circumstances change

### Solution

#### Add Delivery Remarks to Customer Profile

**Data Structure** (`app.js`):
```javascript
customer.deliveryRemarks = {
    default: 'Bezorgen bij de buren indien niet thuis',
    lastUpdated: '2025-10-09',
    history: [
        {
            date: '2025-10-09',
            remark: 'Bezorgen bij de buren indien niet thuis',
            updatedBy: 'Agent Jan Vos'
        }
    ]
};
```

#### Display in Customer Detail View

**HTML** (`index.html`):
Add section after customer address:
```html
<div class="customer-delivery-info">
    <h3>üì¶ Bezorgvoorkeuren</h3>
    <div class="delivery-remarks-display">
        <div class="remark-text" id="customerDeliveryRemarks">
            Bezorgen bij de buren indien niet thuis
        </div>
        <button class="btn btn-small" onclick="editDeliveryRemarks()">
            ‚úèÔ∏è Bewerken
        </button>
    </div>
</div>
```

#### Edit Modal

**HTML**:
```html
<div id="editDeliveryRemarksModal" class="modal">
    <div class="modal-content">
        <h3>Bezorgvoorkeuren bewerken</h3>
        <p>Klant: <strong id="editRemarksCustomerName"></strong></p>
        
        <!-- Quick selection buttons (same as article form) -->
        <div class="delivery-remarks-shortcuts">
            <!-- Same shortcut buttons -->
        </div>
        
        <label for="editCustomerDeliveryRemarks">Standaard bezorginstructies</label>
        <textarea id="editCustomerDeliveryRemarks" 
                  rows="4" 
                  placeholder="Voer bezorginstructies in..."></textarea>
        
        <div class="modal-actions">
            <button onclick="closeEditRemarksModal()">Annuleren</button>
            <button class="btn-primary" onclick="saveDeliveryRemarks()">
                Opslaan
            </button>
        </div>
    </div>
</div>
```

#### Automatic Prefill
When creating article sale for existing customer:
```javascript
function showArticleSale() {
    if (currentCustomer && currentCustomer.deliveryRemarks) {
        document.getElementById('articleNotes').value = 
            currentCustomer.deliveryRemarks.default;
    }
    // ... rest of function
}
```

#### Contact History Entry
Log changes to delivery remarks:
```javascript
contactHistory.unshift({
    type: 'Bezorgvoorkeuren gewijzigd',
    date: new Date().toISOString(),
    description: `Bezorgvoorkeuren bijgewerkt: "${newRemarks}"`
});
```

### Estimated Effort
- Medium (1.5-2 hours)

---

## Implementation Priority

### Phase 1: Quick Wins (Low Effort, High Impact)
1. ‚úÖ Increase textarea size (5 min)
2. ‚úÖ Add article purchases to contact history (1 hour)
3. ‚úÖ Rename delivery date field (15 min)

**Total: ~1.5 hours**

### Phase 2: Medium Impact Features
4. ‚úÖ Delivery remarks shortlist (1-2 hours)
5. ‚úÖ Edit delivery remarks for customers (2 hours)
6. ‚úÖ Cancel article deliveries (2-3 hours)

**Total: ~5-7 hours**

### Phase 3: Complex Features
7. ‚úÖ Advanced delivery date picker (3-4 hours)
8. ‚úÖ Optimize article selection for 100+ items (5-6 hours)

**Total: ~8-10 hours**

---

## Total Estimated Effort
- **Minimum (Basic implementation)**: 7-9 hours
- **Recommended (All features)**: 15-18 hours
- **Maximum (With polish & testing)**: 20-25 hours

---

## Testing Checklist

### Article Sale Form
- [ ] Textarea is properly sized (5 rows minimum)
- [ ] Delivery date picker shows only available dates
- [ ] Sundays are disabled
- [ ] Dutch holidays are disabled
- [ ] Day names are clearly visible
- [ ] Quick date selection buttons work
- [ ] Delivery remark shortcuts insert correctly
- [ ] Multiple remarks can be added
- [ ] Custom remarks can be typed

### Contact History
- [ ] Article purchases appear in timeline
- [ ] Article cancellations are logged
- [ ] Delivery status updates are tracked
- [ ] Delivery remark changes are recorded

### Article Selection
- [ ] Search filters articles correctly
- [ ] Categories are properly organized
- [ ] Popular items appear first
- [ ] Keyboard navigation works
- [ ] Price updates correctly on selection

### Customer Management
- [ ] Delivery remarks save to customer profile
- [ ] Remarks prefill on article sale
- [ ] Remarks can be edited
- [ ] Deceased customer status prevents orders
- [ ] All active deliveries can be cancelled

### Edge Cases
- [ ] Handle customer with no delivery remarks
- [ ] Handle article with no expected delivery date
- [ ] Handle cancellation of already delivered article
- [ ] Handle multiple articles with different statuses
- [ ] Handle customer status transitions

---

## Technical Dependencies

### No External Libraries Required
All features can be implemented with:
- Vanilla JavaScript
- CSS3
- HTML5
- LocalStorage (existing)

### Browser Compatibility
- Modern browsers (Chrome, Firefox, Edge, Safari)
- ES6+ JavaScript features
- CSS Grid and Flexbox

---

## Future Enhancements (Out of Scope)

### Nice-to-Have Features
- Real-time delivery tracking integration
- SMS notifications for delivery updates
- Email templates for delivery confirmations
- Print delivery labels
- Barcode scanning for article codes
- Voice input for delivery remarks
- Multi-language support
- Mobile-optimized view
- Integration with PostNL API for real-time delivery windows
- Analytics dashboard for article sales

---

## Notes
- All changes maintain backward compatibility
- No database changes required (using localStorage)
- Progressive enhancement approach
- Graceful degradation for older browsers
- Maintain existing debug mode functionality
- Keep all Dutch language text
- Follow existing code style and patterns

---

## Sign-off
- [ ] Plan reviewed by development team
- [ ] Plan approved by stakeholders
- [ ] Implementation ready to begin
