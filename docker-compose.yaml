services:
  dev-certs:
    image: alpine:3.19
    command:
      - /bin/sh
      - -c
      - >-
        apk add --no-cache bash openssl >/dev/null &&
        /usr/local/bin/dev-certs.sh &&
        tail -f /dev/null
    environment:
      DOMAIN: bdc.rtvmedia.org.local
      CERT_DIR: /certs
    volumes:
      - ./infra/docker/nginx/certs:/certs
      - ./scripts/dev-certs.sh:/usr/local/bin/dev-certs.sh:ro
    healthcheck:
      test:
        - CMD-SHELL
        - test -f /certs/bdc.rtvmedia.org.local.crt -a -f /certs/bdc.rtvmedia.org.local.key
      interval: 2s
      timeout: 1s
      retries: 10

  app:
    build:
      context: .
      dockerfile: infra/docker/app/Dockerfile
    image: kiwi-dev:local
    command: ["gunicorn", "-b", "0.0.0.0:8000", "--reload", "server:app"]
    environment:
      OIDC_CLIENT_SECRETS: /app/client_secrets.json
    secrets:
      - source: oidc-client-secrets
        target: /app/client_secrets.json
    volumes:
      - ./app:/app
    expose:
      - "8000"

  gateway:
    image: nginx:1.25-alpine
    depends_on:
      app:
        condition: service_started
      dev-certs:
        condition: service_healthy
    ports:
      - "443:443"
    volumes:
      - ./infra/docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./infra/docker/nginx/certs:/etc/nginx/certs:ro

secrets:
  oidc-client-secrets:
    file: ./client_secrets.json
